{"version":3,"sources":["../src/Cache.js"],"names":["RenderCache","props","context","cache","children","cacheKey","update","maxAge","$queue","push","__html","$lru","get","contextTypes","PropTypes","object","Cache","maxSize","max","css","$css","html","length","dom","load","normalizeWhitespace","xmlMode","shift","item","set","parseInt","key","has","seq","replace","match","p1","p2","p3","$adler32","data","a","b","i","l","m","n","Math","min","charCodeAt"],"mappings":"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","file":"Cache.js","sourcesContent":["/* @flow */\nimport LRU from \"lru-cache\";\nimport cheerio from \"cheerio\";\nimport React from 'react';\n\nfunction RenderCache(props: {children: Object, cacheKey: Object, update: Boolean, maxAge: Number}, context) {\n  const cache = context.cache;\n  const { children, cacheKey, update, maxAge } = props;\n  if (cache) {\n    if (update) {\n      if (maxAge) {\n        cache.$queue.push([cacheKey, maxAge]);\n      } else {\n        cache.$queue.push([cacheKey]);\n      }\n    } else {\n      return <div data-dogsled={cacheKey} dangerouslySetInnerHTML={{__html: cache.$lru.get(cacheKey)}}/>;\n    }\n  }\n  return <div data-dogsled={cacheKey}>{children}</div>;\n}\nRenderCache.contextTypes = {\n  cache: React.PropTypes.object\n};\n\nclass Cache {\n  constructor (maxSize:Number, maxAge:Number) {\n    this.$lru = LRU({\n      max: maxSize || 1000,\n      maxAge: maxAge || 1000 * 60 * 60\n    });\n\n    this.$queue = [];\n  }\n\n  setInitialCss(css:String) {\n    if (!this.$css) {\n      this.$css = css;\n    }\n  }\n\n  getCss() {\n    return this.$css;\n  }\n\n  setHtml(html:String) {\n    if (this.$queue.length > 0) {\n      const dom = cheerio.load(html, {\n        normalizeWhitespace: true,\n        xmlMode: true\n      });\n      while (this.$queue.length > 0) {\n        const [cacheKey, maxAge] = this.$queue.shift();\n        const item = dom(`[data-dogsled=\"${cacheKey}\"]`);\n        if (maxAge) {\n          this.$lru.set(cacheKey, item.html(), parseInt(maxAge));\n        } else {\n          this.$lru.set(cacheKey, item.html());\n        }\n      }\n    }\n  }\n\n  renderJSX(\n    children: Object,\n    key,\n    maxAge\n  ){\n    if (key) {\n      if (this.$lru.has(key)) {\n        return <RenderCache cacheKey={key} update={false}/>;\n      }\n      return <RenderCache cacheKey={key} maxAge={maxAge} update={true}>{children}</RenderCache>;\n    }\n    return <RenderCache cacheKey={key}>{children}</RenderCache>;\n  };\n\n  prepareForCache(html:String) {\n    // resequence ids\n    let seq = 1;\n    html = html.replace(/(data-reactid|react-text)(=\\\"*|:\\s*)\\d+(\\\"*)/g,\n      (match, p1, p2, p3)=>{ return p1 + p2 + (seq++) + p3; });\n\n    // update checksum\n    html = html.replace(/(\\s+data-react-checksum=\")[^\\\"]*(\"\\s*)/,\n      (match, p1, p2)=>{\n        return p1 +\n        this.$adler32(html.replace(/\\s+data-react-checksum=\"[^\\\"]*\"\\s*/, '')) +\n        p2\n      }\n    );\n\n    return html;\n  }\n\n  // stolen from React (for now)\n  $adler32(data:String) {\n    var a = 1, b = 0, i = 0, l = data.length, m = l & ~0x3;\n    while (i < m) {\n      var n = Math.min(i + 4096, m);\n      for (; i < n; i += 4) {\n        b += (a += data.charCodeAt(i)) + (a += data.charCodeAt(i + 1)) + (a += data.charCodeAt(i + 2)) + (a += data.charCodeAt(i + 3));\n      }\n      a %= 65521;\n      b %= 65521;\n    }\n    for (; i < l; i++) {\n      b += a += data.charCodeAt(i);\n    }\n    a %= 65521;\n    b %= 65521;\n    return a | b << 16;\n  }\n}\n\nexport default Cache;\n"]}